/*!
 * Web UI Data Loader - https://webui.stoicdreams.com/components#webui-data-loader
 * A component for loading and managing data from external sources.
 * Authored by Erik Gassler - Stoic Dreams
 * Copyright Â© 2024-2025 Stoic Dreams - https://www.stoicdreams.com
 * Licensed under the MIT license - https://github.com/StoicDreams/MyFiCDN/blob/main/LICENSE
 */
"use strict";webui.define("webui-data-loader",{constructor(){this.map={},this.delay=10},attr:["src","keymap","auth","apiroot","delay"],attrChanged(property,value){const t=this;switch(property){case"auth":t.usesAuth=!0;break;case"delay":t.delay=parseInt(value)||10;break;case"keymap":try{t.map=JSON.parse(value)}catch(_){}}t.isProcessed&&t.process()},connected(){this.process()},async processPath(src,dataKey){const t=this;setTimeout((()=>{!async function(){if(t.usesAuth&&!t.auth)return void console.error("webui-data-loader cannot load data: [auth] is not set with a data key.");let fo={headers:{}};if(src.startsWith("http")&&(fo.mode="cors"),!t.auth||(fo.headers.Authorization=webui.getData(t.auth),fo.headers.Authorization))try{let result=await fetch(src,fo);if(!result.ok)return void console.error("webui-data-loader failed: request returned invalid response",result);let payload=await result.text();try{payload=JSON.parse(payload),webui.setData(webui.toSnake(dataKey,"-"),payload)}catch(ex){webui.setData(webui.toSnake(dataKey,"-"),payload)}}catch(ex){return void console.error("webui-data-loader failed loading data:",ex)}else console.error("webui-data-loader cannot load data: auth key did not find expected data.")}()}),t.delay||10)},async process(){const t=this;if(t._sid||(t._sid=webui.uuid()),t._attempts=(t._attempts||0)+1,t.isProcessed=!0,t.auth&&!webui.getData(t.auth))return t._attempts>4?void console.error(`webui-data-loader failed: Expected auth ${t.auth} returned invalid data.`):void setTimeout((()=>{t.process()}),Math.pow(10,t._attempts));let apiRoot="";if(t.apiroot&&(apiRoot=webui.getData(t.apiroot),!apiRoot))return t._attempts>4?void console.error(`webui-data-loader failed: Expected api root ${t.apiroot} returned invalid data.`):void setTimeout((()=>{t.process()}),Math.pow(10,t._attempts));t.src&&(t.dataset.trigger?(t.processPath(`${apiRoot}${t.src}`,t.dataset.trigger),t.dataset.trigger=void 0,t.src=void 0):console.error('webui-data-loader failed: src must be used in conjunction with [data-trigger="variable-name"] to signify which data key to assign data to.')),Object.keys(t.dataset).forEach((key=>{let apiRoute=t.dataset[key];if(apiRoot){let src=`${apiRoot}${apiRoute}`;t.processPath(src,key)}}))}});